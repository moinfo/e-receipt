<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - E-Receipt System</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="app-container">
        <div class="card" style="max-width: 500px; width: 100%;">
            <div class="card-body">
                <div class="text-center" style="margin-bottom: 2rem;">
                    <div class="brand-logo" style="width: 80px; height: 80px; margin: 0 auto 1rem; background: linear-gradient(135deg, var(--primary-orange) 0%, var(--hover-orange) 100%); border: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                        </svg>
                    </div>
                    <h2 class="welcome-title">Forgot Password</h2>
                    <p class="welcome-subtitle">Answer your secret question to reset your password</p>
                </div>

                <div id="alertContainer"></div>

                <!-- Step 1: Enter Username -->
                <div id="step1">
                    <form id="usernameForm">
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <div class="input-group">
                                <span class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                    </svg>
                                </span>
                                <input type="text" id="username" name="username" class="form-control" placeholder="Enter your username" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="usernameBtn">
                            <span id="usernameBtnText">CONTINUE</span>
                            <div id="usernameBtnSpinner" class="spinner hidden"></div>
                        </button>

                        <div class="text-center mt-3">
                            <a href="login.html" style="color: #9CA3AF;">Back to Login</a>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Answer Secret Question -->
                <div id="step2" class="hidden">
                    <form id="resetForm">
                        <div style="background-color: var(--dark-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <label style="color: #9CA3AF; font-size: 0.85rem; display: block; margin-bottom: 0.5rem;">Secret Question</label>
                            <p id="secretQuestion" style="margin: 0; font-weight: 500;"></p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Your Answer</label>
                            <div class="input-group">
                                <span class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                                    </svg>
                                </span>
                                <input type="text" id="secretAnswer" name="secretAnswer" class="form-control" placeholder="Enter your answer" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <div class="input-group">
                                <span class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                                    </svg>
                                </span>
                                <input type="password" id="newPassword" name="newPassword" class="form-control" placeholder="Enter new password (min. 6 chars)" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <div class="input-group">
                                <span class="input-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                                    </svg>
                                </span>
                                <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" placeholder="Confirm new password" required>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="resetBtn">
                            <span id="resetBtnText">RESET PASSWORD</span>
                            <div id="resetBtnSpinner" class="spinner hidden"></div>
                        </button>

                        <div class="text-center mt-3">
                            <a href="#" onclick="goBack(); return false;" style="color: #9CA3AF;">Try different username</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        let currentUsername = '';

        // Handle username form submission
        document.getElementById('usernameForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();

            if (!username) {
                showAlert('Please enter your username', 'error');
                return;
            }

            // Show loading
            showLoading('usernameBtn', 'usernameBtnText', 'usernameBtnSpinner');

            try {
                const response = await fetch('../api/auth/forgot-password.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();

                if (data.success) {
                    currentUsername = username;
                    document.getElementById('secretQuestion').textContent = data.data.secret_question;

                    // Show step 2
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                } else {
                    showAlert(data.message, 'error');
                    hideLoading('usernameBtn', 'usernameBtnText', 'usernameBtnSpinner');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('An error occurred. Please try again.', 'error');
                hideLoading('usernameBtn', 'usernameBtnText', 'usernameBtnSpinner');
            }
        });

        // Handle reset form submission
        document.getElementById('resetForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const secretAnswer = document.getElementById('secretAnswer').value.trim();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate
            if (!secretAnswer) {
                showAlert('Please answer the secret question', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters long', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            // Show loading
            showLoading('resetBtn', 'resetBtnText', 'resetBtnSpinner');

            try {
                const response = await fetch('../api/auth/reset-password.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: currentUsername,
                        secret_answer: secretAnswer,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Password reset successful! Redirecting to login...', 'success');

                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showAlert(data.message, 'error');
                    hideLoading('resetBtn', 'resetBtnText', 'resetBtnSpinner');
                }
            } catch (error) {
                console.error('Reset error:', error);
                showAlert('An error occurred. Please try again.', 'error');
                hideLoading('resetBtn', 'resetBtnText', 'resetBtnSpinner');
            }
        });

        // Go back to step 1
        function goBack() {
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('usernameForm').reset();
            document.getElementById('resetForm').reset();
            hideLoading('usernameBtn', 'usernameBtnText', 'usernameBtnSpinner');
            currentUsername = '';
        }
    </script>
</body>
</html>
