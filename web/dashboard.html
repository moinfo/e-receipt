<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - E-Receipt System</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">E-RECEIPT</div>
        <div class="navbar-menu">
            <a href="dashboard.html" class="navbar-link active">Dashboard</a>
            <a href="upload-receipt.html" class="navbar-link">Upload Receipt</a>
            <a href="history.html" class="navbar-link">History</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Dashboard</h1>
            <p class="dashboard-subtitle">Welcome back! Here's your receipt overview</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Statistics Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v18.5c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5V2l-1.5 1.5z"/>
                    </svg>
                </div>
                <div class="stat-value" id="totalReceipts">0</div>
                <div class="stat-label">Total Receipts</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                <div class="stat-value" id="banksUsed">0</div>
                <div class="stat-label">Banks Used</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                    </svg>
                </div>
                <div class="stat-value" id="totalAmount">$0.00</div>
                <div class="stat-label">Total Amount</div>
            </div>

            <div class="stat-card">
                <div class="stat-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                </div>
                <div class="stat-value" id="lastUpload" style="font-size: 1rem;">-</div>
                <div class="stat-label">Last Upload</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-body">
                <h3 style="margin-bottom: 1.5rem;">Quick Actions</h3>
                <div class="d-flex gap-2" style="flex-wrap: wrap;">
                    <a href="upload-receipt.html" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                        </svg>
                        Upload New Receipt
                    </a>
                    <a href="history.html" class="btn btn-secondary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                        </svg>
                        View History
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Receipts -->
        <div class="table-container" style="margin-top: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Recent Receipts</h3>
            <div id="loadingReceipts" class="text-center" style="padding: 2rem;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: #9CA3AF;">Loading receipts...</p>
            </div>
            <table id="receiptsTable" class="hidden">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Bank</th>
                        <th>Receipt #</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="receiptsBody">
                </tbody>
            </table>
            <div id="noReceipts" class="hidden text-center" style="padding: 3rem; color: #9CA3AF;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3; margin-bottom: 1rem;">
                    <path d="M19.5 3.5L18 2l-1.5 1.5L15 2l-1.5 1.5L12 2l-1.5 1.5L9 2 7.5 3.5 6 2 4.5 3.5 3 2v18.5c0 .83.67 1.5 1.5 1.5h15c.83 0 1.5-.67 1.5-1.5V2l-1.5 1.5z"/>
                </svg>
                <h3>No Receipts Yet</h3>
                <p>Start by uploading your first receipt</p>
                <a href="upload-receipt.html" class="btn btn-primary mt-2">Upload Receipt</a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" style="margin-top: auto;">
        <p>&copy; 2025 E-Receipt System. All rights reserved.</p>
    </div>

    <!-- Receipt View Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Receipt Details</h3>
                <button class="modal-close" onclick="closeModal('receiptModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receiptDetails"></div>
            </div>
        </div>
    </div>

    <script src="assets/js/app.js"></script>
    <script>
        let currentUser = null;

        // Initialize dashboard
        async function initDashboard() {
            currentUser = checkAuth();
            if (!currentUser) return;

            updateNavbar(currentUser);
            await loadStatistics();
            await loadRecentReceipts();
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const data = await apiRequest('/receipts/user-history.php');

                if (data.success) {
                    const stats = data.statistics;

                    document.getElementById('totalReceipts').textContent = stats.total_receipts || 0;
                    document.getElementById('banksUsed').textContent = stats.banks_used || 0;
                    document.getElementById('totalAmount').textContent = formatCurrency(stats.total_amount);

                    if (stats.last_upload) {
                        const lastUploadDate = new Date(stats.last_upload);
                        const now = new Date();
                        const diffTime = Math.abs(now - lastUploadDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays === 0) {
                            document.getElementById('lastUpload').textContent = 'Today';
                        } else if (diffDays === 1) {
                            document.getElementById('lastUpload').textContent = 'Yesterday';
                        } else if (diffDays < 7) {
                            document.getElementById('lastUpload').textContent = diffDays + ' days ago';
                        } else {
                            document.getElementById('lastUpload').textContent = formatDate(stats.last_upload).split(',')[0];
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Load recent receipts (today only)
        async function loadRecentReceipts() {
            try {
                const data = await apiRequest('/receipts/user-history.php?today=true');

                document.getElementById('loadingReceipts').classList.add('hidden');

                if (data.success && data.data.length > 0) {
                    document.getElementById('receiptsTable').classList.remove('hidden');
                    displayReceipts(data.data.slice(0, 5)); // Show only 5 most recent
                } else {
                    document.getElementById('noReceipts').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load receipts:', error);
                document.getElementById('loadingReceipts').classList.add('hidden');
                showAlert('Failed to load receipts', 'error');
            }
        }

        // Display receipts in table
        function displayReceipts(receipts) {
            const tbody = document.getElementById('receiptsBody');
            tbody.innerHTML = '';

            receipts.forEach(receipt => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(receipt.upload_date)}</td>
                    <td>${receipt.bank_name || '-'}</td>
                    <td>${receipt.receipt_number || '-'}</td>
                    <td>${formatCurrency(receipt.amount)}</td>
                    <td>${receipt.description || '-'}</td>
                    <td>
                        <button onclick="viewReceipt(${receipt.id}, '${receipt.receipt_image_path}')" class="btn btn-secondary btn-sm">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // View receipt
        function viewReceipt(id, imagePath) {
            const details = document.getElementById('receiptDetails');
            const receiptUrl = BASE_PATH + '/api/' + imagePath;
            const isPDF = imagePath.toLowerCase().endsWith('.pdf');

            if (isPDF) {
                // For PDFs, show embedded viewer
                details.innerHTML = `
                    <div class="text-center">
                        <embed src="${receiptUrl}" type="application/pdf" style="width: 100%; height: 500px; border-radius: 8px; margin-bottom: 1rem;">
                        <div class="d-flex gap-2 justify-between">
                            <a href="${receiptUrl}" target="_blank" class="btn btn-secondary" style="flex: 1;">
                                Open in New Tab
                            </a>
                            <a href="${receiptUrl}" download class="btn btn-primary" style="flex: 1;">
                                Download
                            </a>
                        </div>
                    </div>
                `;
            } else {
                // For images, show image
                details.innerHTML = `
                    <div class="text-center">
                        <img src="${receiptUrl}" alt="Receipt" style="max-width: 100%; border-radius: 8px; margin-bottom: 1rem;">
                        <div class="d-flex gap-2 justify-between">
                            <a href="${receiptUrl}" target="_blank" class="btn btn-secondary" style="flex: 1;">
                                Open in New Tab
                            </a>
                            <a href="${receiptUrl}" download class="btn btn-primary" style="flex: 1;">
                                Download
                            </a>
                        </div>
                    </div>
                `;
            }
            openModal('receiptModal');
        }

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('receiptModal');
            if (event.target === modal) {
                closeModal('receiptModal');
            }
        }

        // Initialize on page load
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
