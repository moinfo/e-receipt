<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Management - E-Receipt System</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">E-RECEIPT ADMIN</div>
        <div class="navbar-menu">
            <a href="dashboard.html" class="navbar-link">Dashboard</a>
            <a href="pending-users.html" class="navbar-link">Pending Users</a>
            <a href="all-receipts.html" class="navbar-link">All Receipts</a>
            <a href="banks.html" class="navbar-link active">Banks</a>
            <a href="users.html" class="navbar-link">Users</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Bank Management</h1>
            <p class="dashboard-subtitle">Manage bank information</p>
        </div>

        <div id="alertContainer"></div>

        <!-- Add Bank Button -->
        <div style="margin-bottom: 2rem;">
            <button onclick="openAddModal()" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle;">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Add New Bank
            </button>
        </div>

        <!-- Banks Table -->
        <div class="table-container">
            <div id="loadingBanks" class="text-center" style="padding: 2rem;">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p style="margin-top: 1rem; color: #9CA3AF;">Loading banks...</p>
            </div>

            <table id="banksTable" class="hidden">
                <thead>
                    <tr>
                        <th>Bank Name</th>
                        <th>Bank Code</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="banksBody">
                </tbody>
            </table>

            <div id="noBanks" class="hidden text-center" style="padding: 3rem; color: #9CA3AF;">
                <h3>No Banks Found</h3>
                <p>Add a new bank to get started</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer" style="margin-top: auto;">
        <p>&copy; 2025 E-Receipt System. All rights reserved.</p>
    </div>

    <!-- Add/Edit Bank Modal -->
    <div id="bankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Add New Bank</h3>
                <button class="modal-close" onclick="closeModal('bankModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="bankForm">
                    <input type="hidden" id="bankId">

                    <div class="form-group">
                        <label class="form-label">Bank Name *</label>
                        <input type="text" id="bankName" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bank Code</label>
                        <input type="text" id="bankCode" class="form-control" placeholder="Optional">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="bankStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitBtn">
                            <span id="btnText">Save Bank</span>
                            <div id="btnSpinner" class="spinner hidden"></div>
                        </button>
                        <button type="button" onclick="closeModal('bankModal')" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        let currentUser = null;
        let banks = [];
        let editingBankId = null;

        // Initialize page
        async function initBanks() {
            currentUser = checkAdmin();
            if (!currentUser) return;

            updateNavbar(currentUser);
            await loadBanks();
        }

        // Load all banks
        async function loadBanks() {
            try {
                const data = await apiRequest('/admin/banks.php');

                document.getElementById('loadingBanks').classList.add('hidden');

                if (data.success && data.data.length > 0) {
                    banks = data.data;
                    displayBanks();
                } else {
                    document.getElementById('noBanks').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Failed to load banks:', error);
                document.getElementById('loadingBanks').classList.add('hidden');
                showAlert('Failed to load banks', 'error');
            }
        }

        // Display banks
        function displayBanks() {
            const tbody = document.getElementById('banksBody');
            const table = document.getElementById('banksTable');
            const noBanks = document.getElementById('noBanks');

            tbody.innerHTML = '';

            if (banks.length === 0) {
                table.classList.add('hidden');
                noBanks.classList.remove('hidden');
                return;
            }

            table.classList.remove('hidden');
            noBanks.classList.add('hidden');

            banks.forEach(bank => {
                const row = document.createElement('tr');

                const statusBadge = bank.status === 'active'
                    ? '<span class="badge badge-approved">Active</span>'
                    : '<span class="badge badge-pending">Inactive</span>';

                row.innerHTML = `
                    <td><strong>${bank.bank_name}</strong></td>
                    <td>${bank.bank_code || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDate(bank.created_at)}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="editBank(${bank.id})" class="btn btn-secondary btn-sm">Edit</button>
                        <button onclick="deleteBank(${bank.id}, '${bank.bank_name}')" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Open add modal
        function openAddModal() {
            editingBankId = null;
            document.getElementById('modalTitle').textContent = 'Add New Bank';
            document.getElementById('bankForm').reset();
            document.getElementById('bankId').value = '';
            document.getElementById('bankStatus').value = 'active';
            openModal('bankModal');
        }

        // Edit bank
        function editBank(id) {
            const bank = banks.find(b => b.id === id);
            if (!bank) return;

            editingBankId = id;
            document.getElementById('modalTitle').textContent = 'Edit Bank';
            document.getElementById('bankId').value = bank.id;
            document.getElementById('bankName').value = bank.bank_name;
            document.getElementById('bankCode').value = bank.bank_code || '';
            document.getElementById('bankStatus').value = bank.status;
            openModal('bankModal');
        }

        // Handle form submission
        document.getElementById('bankForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const bankId = document.getElementById('bankId').value;
            const bankName = document.getElementById('bankName').value.trim();
            const bankCode = document.getElementById('bankCode').value.trim();
            const status = document.getElementById('bankStatus').value;

            if (!bankName) {
                showAlert('Bank name is required', 'error');
                return;
            }

            showLoading('submitBtn', 'btnText', 'btnSpinner');

            try {
                const endpoint = bankId ? '/admin/bank-update.php' : '/admin/bank-create.php';
                const payload = {
                    bank_name: bankName,
                    bank_code: bankCode || null,
                    status: status
                };

                if (bankId) {
                    payload.id = bankId;
                }

                const data = await apiRequest(endpoint, bankId ? 'PUT' : 'POST', payload);

                if (data.success) {
                    showAlert(bankId ? 'Bank updated successfully' : 'Bank created successfully', 'success');
                    closeModal('bankModal');
                    await loadBanks();
                } else {
                    showAlert(data.message || 'Operation failed', 'error');
                }
            } catch (error) {
                console.error('Failed to save bank:', error);
                showAlert('An error occurred while saving bank', 'error');
            } finally {
                hideLoading('submitBtn', 'btnText', 'btnSpinner');
            }
        });

        // Delete bank
        async function deleteBank(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"? This action cannot be undone if the bank is not used by any receipts.`)) {
                return;
            }

            try {
                const data = await apiRequest('/admin/bank-delete.php', 'DELETE', { id: id });

                if (data.success) {
                    showAlert('Bank deleted successfully', 'success');
                    await loadBanks();
                } else {
                    showAlert(data.message || 'Failed to delete bank', 'error');
                }
            } catch (error) {
                console.error('Failed to delete bank:', error);
                showAlert('An error occurred while deleting bank', 'error');
            }
        }

        // Initialize on page load
        window.addEventListener('load', initBanks);
    </script>
</body>
</html>
